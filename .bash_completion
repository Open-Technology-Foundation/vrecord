#!/bin/bash
# vrecord bash completion
# Copyright (C) 2024 Generated with Claude Code
# GPL-3.0-or-later

_vrecord() {
  local cur prev opts cmd
  COMPREPLY=()
  cur="${COMP_WORDS[COMP_CWORD]}"
  prev="${COMP_WORDS[COMP_CWORD-1]}"

  # Global options that can appear anywhere
  local global_opts="-n --no-mp3 -b --no-beep -v --verbose -q --quiet -h --help -V --version"

  # All commands
  local commands="start pause resume stop status list help"

  # Find the command (skip global options)
  cmd=""
  local i=1
  while [[ $i -lt $COMP_CWORD ]]; do
    case "${COMP_WORDS[i]}" in
      -n|--no-mp3|-b|--no-beep|-v|--verbose|-q|--quiet|-h|--help|-V|--version)
        # Single argument global options
        ;;
      -*)
        # Unknown option, skip
        ;;
      *)
        # This should be the command
        cmd="${COMP_WORDS[i]}"
        break
        ;;
    esac
    ((i++))
  done

  # If no command found yet, suggest commands or global options
  if [[ -z "$cmd" ]]; then
    case "$cur" in
      -*)
        COMPREPLY=($(compgen -W "$global_opts" -- "$cur"))
        ;;
      *)
        COMPREPLY=($(compgen -W "$commands $global_opts" -- "$cur"))
        ;;
    esac
    return 0
  fi

  # Command-specific completions
  case "$cmd" in
    start)
      case "$prev" in
        -r|--resume)
          # Complete with .wav files from recording directory
          local recording_dir="${VRECORD_RECORDING_DIR:-$HOME/Recordings}"
          if [[ -d "$recording_dir" ]]; then
            COMPREPLY=($(compgen -f -X '!*.wav' -W "$(cd "$recording_dir" 2>/dev/null && ls *.wav 2>/dev/null)" -- "$cur"))
          fi
          ;;
        *)
          case "$cur" in
            -*)
              COMPREPLY=($(compgen -W "-c --continue-last -r --resume -t --transcribe $global_opts" -- "$cur"))
              ;;
            *)
              # For start command, don't complete filenames as they are prefixes
              COMPREPLY=()
              ;;
          esac
          ;;
      esac
      ;;

    stop)
      case "$cur" in
        -*)
          COMPREPLY=($(compgen -W "-t --transcribe $global_opts" -- "$cur"))
          ;;
        *)
          COMPREPLY=()
          ;;
      esac
      ;;

    list)
      case "$cur" in
        -*)
          COMPREPLY=($(compgen -W "--all $global_opts" -- "$cur"))
          ;;
        *)
          COMPREPLY=()
          ;;
      esac
      ;;

    pause|resume|status|help)
      case "$cur" in
        -*)
          COMPREPLY=($(compgen -W "$global_opts" -- "$cur"))
          ;;
        *)
          COMPREPLY=()
          ;;
      esac
      ;;

    *)
      # Unknown command, suggest global options only
      case "$cur" in
        -*)
          COMPREPLY=($(compgen -W "$global_opts" -- "$cur"))
          ;;
        *)
          COMPREPLY=()
          ;;
      esac
      ;;
  esac

  return 0
}

# Register completion function
complete -F _vrecord vrecord

# Support completion when script is called directly with ./vrecord
complete -F _vrecord ./vrecord